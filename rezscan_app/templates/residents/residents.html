{% extends "layout.html" %}

{% macro sort_link(column_name, label) %}
  {% set current_sort = sort %}
  {% set current_dir = direction %}
  {% set next_dir = 'desc' if current_sort == column_name and current_dir == 'asc' else 'asc' %}
  <a href="{{ url_for('residents.residents', search=search, sort=column_name, direction=next_dir, page=page, filterUnit=filterUnit, filterHousing=filterHousing, filterLevel=filterLevel) }}" class="text-decoration-none">
    {{ label }}
    {% if current_sort == column_name %}
      {% if current_dir == 'asc' %}▲{% else %}▼{% endif %}
    {% endif %}
  </a>
{% endmacro %}

{% block title %}Residents - RezScan{% endblock %}

{% block content %}
<h2 class="mb-4">Residents</h2>

<!-- Add Resident Button -->
{% if current_user.role in ['admin', 'officer'] %}
  <div class="mb-3">
    <a href="{{ url_for('residents.add_resident') }}" class="btn btn-primary" aria-label="Add New Resident">Add Resident</a>
  </div>
{% endif %}

<!-- Search and Filters -->
<form id="filterForm" action="{{ url_for('residents.residents') }}" method="GET">
  <div class="row row-cols-1 row-cols-md-5 g-3 align-items-end mb-4">
    <div class="col">
      <input type="text" id="searchInput" name="search" class="form-control" placeholder="Search by Name or MDOC..." value="{{ search }}">
    </div>
    <div class="col">
      <select id="filterUnit" name="filterUnit" class="form-select">
        <option value="">All Units</option>
        {% for unit in UNIT_OPTIONS %}
          <option value="{{ unit }}" {% if filterUnit == unit %}selected{% endif %}>{{ unit }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <select id="filterHousing" name="filterHousing" class="form-select">
        <option value="">All Housing</option>
        {% for housing in HOUSING_OPTIONS %}
          <option value="{{ housing }}" {% if filterHousing == housing %}selected{% endif %}>{{ housing }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <select id="filterLevel" name="filterLevel" class="form-select">
        <option value="">All Levels</option>
        {% for level in LEVEL_OPTIONS %}
          <option value="{{ level }}" {% if filterLevel == level %}selected{% endif %}>{{ level }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col">
      <button type="button" class="btn btn-secondary w-100" onclick="resetFilters()">Clear Filters</button>
    </div>
  </div>
  <input type="hidden" name="sort" value="{{ sort }}">
  <input type="hidden" name="direction" value="{{ direction }}">
  <input type="hidden" name="page" value="{{ page }}">
</form>

<!-- Resident Count and Page Info -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="mb-0">
    Showing {{ filtered_count }} of {{ total_count }} residents
    {% if search or filterUnit or filterHousing or filterLevel %}(filtered){% endif %}
    | Page {{ page }} of {{ total_pages }}
  </p>
</div>

<!-- Residents Table -->
<div class="table-responsive">
  <table id="residentsTable" class="table table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>{{ sort_link('name', 'Name') }}</th>
        <th>{{ sort_link('mdoc', 'MDOC') }}</th>
        <th>Unit</th>
        <th>Housing</th>
        <th>{{ sort_link('level', 'Level') }}</th>
        {% if current_user.role in ['admin', 'officer'] %}
          <th class="text-center">Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for resident in residents %}
        <tr>
          <td>{{ resident.name }}</td>
          <td>{{ resident.mdoc }}</td>
          <td>{{ resident.unit }}</td>
          <td>{{ resident.housing_unit }}</td>
          <td>{{ resident.level }}</td>
          {% if current_user.role in ['admin', 'officer'] %}
            <td class="text-center">
              <a href="{{ url_for('residents.edit_resident', mdoc=resident.mdoc) }}" class="btn btn-sm btn-outline-primary">Edit</a>
              {% if current_user.role == 'admin' %}
              <form action="{{ url_for('residents.delete_resident', mdoc=resident.mdoc) }}" method="POST" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete {{ resident.name }}?');">
                <button type="submit" class="btn btn-sm btn-outline-danger" aria-label="Delete resident {{ resident.name }}">Delete</button>
              </form>
              {% endif %}
            </td>
          {% endif %}
        </tr>
      {% else %}
        <tr>
          <td colspan="{% if current_user.role in ['admin', 'officer'] %}6{% else %}5{% endif %}" class="text-center text-muted">No residents found.</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<nav aria-label="Residents Pagination" class="mt-4">
  <ul class="pagination justify-content-center">
    <!-- First Page -->
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('residents.residents', page=1, search=search, sort=sort, direction=direction, filterUnit=filterUnit, filterHousing=filterHousing, filterLevel=filterLevel) }}">First</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">First</span>
      </li>
    {% endif %}

    <!-- Previous Page -->
    {% if page > 1 %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('residents.residents', page=page-1, search=search, sort=sort, direction=direction, filterUnit=filterUnit, filterHousing=filterHousing, filterLevel=filterLevel) }}">Previous</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Previous</span>
      </li>
    {% endif %}

    <!-- Page Numbers -->
    {% set range_size = 5 %}
    {% set half_range = range_size // 2 %}
    {% set start_page = [page - half_range, 1] | max %}
    {% set end_page = [start_page + range_size - 1, total_pages] | min %}
    {% if end_page - start_page < range_size - 1 %}
      {% set start_page = [end_page - range_size + 1, 1] | max %}
    {% endif %}
    {% for p in range(start_page, end_page + 1) %}
      <li class="page-item {% if p == page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('residents.residents', page=p, search=search, sort=sort, direction=direction, filterUnit=filterUnit, filterHousing=filterHousing, filterLevel=filterLevel) }}">{{ p }}</a>
      </li>
    {% endfor %}

    <!-- Next Page -->
    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('residents.residents', page=page+1, search=search, sort=sort, direction=direction, filterUnit=filterUnit, filterHousing=filterHousing, filterLevel=filterLevel) }}">Next</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Next</span>
      </li>
    {% endif %}

    <!-- Last Page -->
    {% if page < total_pages %}
      <li class="page-item">
        <a class="page-link" href="{{ url_for('residents.residents', page=total_pages, search=search, sort=sort, direction=direction, filterUnit=filterUnit, filterHousing=filterHousing, filterLevel=filterLevel) }}">Last</a>
      </li>
    {% else %}
      <li class="page-item disabled">
        <span class="page-link">Last</span>
      </li>
    {% endif %}
  </ul>
</nav>

<script>
  function resetFilters() {
    window.location = "{{ url_for('residents.residents', sort=sort, direction=direction, page=1) }}";
  }

  // Debounce function to delay execution
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }

  // Auto-submit form on filter changes
  const form = document.getElementById("filterForm");
  document.getElementById("searchInput").addEventListener('input', debounce(() => {
    form.submit();
  }, 500));
  document.getElementById("filterUnit").addEventListener('change', () => {
    form.submit();
  });
  document.getElementById("filterHousing").addEventListener('change', () => {
    form.submit();
  });
  document.getElementById("filterLevel").addEventListener('change', () => {
    form.submit();
  });
</script>
{% endblock %}