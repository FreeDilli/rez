{% extends "layout.html" %}
{% block title %}Import History{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üìú Import History</h2>

  <table class="table table-striped table-hover align-middle">
    <thead class="table-dark">
      <tr>
        {% for header in IMPORT_HISTORY_TABLE_HEADERS[:-1] %}
          <th scope="col">{{ header }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for row in history %}
        {% set is_rollback = row['csv_content'] and 'ROLLBACK' in row['csv_content'] %}
        <tr class="{% if is_rollback %}table-warning{% endif %}">
          <td>{{ row['timestamp'] }}</td>
          <td>{{ row['username'] }}</td>
          <td><span class="badge bg-success">{{ row['added'] }}</span></td>
          <td><span class="badge bg-warning text-dark">{{ row['updated'] }}</span></td>
          <td><span class="badge bg-danger">{{ row['deleted'] }}</span></td>
          <td><span class="badge bg-dark">{{ row['failed'] }}</span></td>
          <td><span class="badge bg-secondary">{{ row['total'] }}</span></td>
          <td>
            {% if is_rollback %}
              <span class="badge bg-warning text-dark">‚Ü©Ô∏è Rollback</span>
            {% else %}
              <a href="{{ url_for('import_history.view_import_snapshot', id=row['id']) }}" class="btn btn-sm btn-outline-secondary" aria-label="View import snapshot">üîç View</a>
              <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#confirmUndoModal{{ row['id'] }}" aria-label="Undo import">
                ‚Ü©Ô∏è Undo
              </button>

              <!-- Modal -->
              <div class="modal fade" id="confirmUndoModal{{ row['id'] }}" tabindex="-1" aria-labelledby="confirmUndoLabel{{ row['id'] }}" aria-describedby="confirmUndoDesc{{ row['id'] }}" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="confirmUndoLabel{{ row['id'] }}">Confirm Rollback</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" id="confirmUndoDesc{{ row['id'] }}">
                      Are you sure you want to rollback import <strong>#{{ row['id'] }}</strong>? This will reverse any added/updated/deleted residents.
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                      <form method="POST" action="{{ url_for('import_history.rollback_import', id=row['id']) }}">
                        <button type="submit" class="btn btn-danger" aria-label="Confirm rollback">‚Ü©Ô∏è Confirm Undo</button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            {% endif %}
          </td>
        </tr>
      {% else %}
        <tr><td colspan="{{ IMPORT_HISTORY_TABLE_HEADERS|length - 1 }}" class="text-center text-muted">No import history yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  var toastElList = [].slice.call(document.querySelectorAll('.toast'));
  toastElList.map(function (toastEl) {
    return new bootstrap.Toast(toastEl).show();
  });
});
</script>
{% endblock %}