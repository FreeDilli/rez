{% extends "layout.html" %}
{% block title %}Import Residents{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üì• Import Residents</h2>
  {% if current_user.role in ['admin', 'officer'] %}
  <p class="mb-4">
    Want to add a single resident? 
    <a href="{{ url_for('residents.add_resident') }}" aria-label="Add Single Resident">Click here</a>
  </p>
{% endif %}
  <div class="alert alert-secondary" id="instructionsBox">
    <h5 class="mb-1">üìÑ CSV Import Guidelines</h5>
    <ul class="mb-1">
      <li><strong>Required headers:</strong> <code>{{ CSV_REQUIRED_HEADERS|join(', ') }}</code></li>
      <li><strong>Optional header:</strong> <code>{{ CSV_OPTIONAL_HEADERS|join(', ') }}</code></li>
      <li>Headers are <em>case-insensitive</em> (e.g., <code>Name</code> or <code>name</code> are both valid)</li>
      <li>Rows without a valid <code>mdoc</code> will be skipped</li>
    </ul>
    <a href="{{ url_for('static', filename='residents_template.csv') }}" class="btn btn-outline-secondary btn-sm" aria-label="Download Sample CSV">üìÑ Download Sample CSV</a>
  </div>
  <!-- Upload Form -->
  <form id="uploadForm" class="mb-4">
    <div class="form-group mb-3">
      <label for="csv_file" class="form-label">Upload CSV File</label>
      <input class="form-control" type="file" name="csv_file" id="csv_file" accept=".csv" required aria-label="Upload CSV File">
      <div id="fileError" class="invalid-feedback"></div>
    </div>
    <div class="form-group mb-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="dry_run" value="yes" id="dry_run" aria-label="Dry Run">
        <label class="form-check-label" for="dry_run">üîç Dry Run (Preview without saving)</label>
      </div>
    </div>
    <button type="submit" class="btn btn-primary" aria-label="Submit CSV">Submit</button>
  </form>

  <!-- Progress Bar -->
  <div class="mb-4 d-none" id="progressContainer">
    <label class="form-label">Upload Progress</label>
    <div class="progress">
      <div id="uploadProgress" class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
    </div>
  </div>

  <!-- Output Preview / Results -->
  <div id="output" class="mt-4"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-describedby="confirmModalDesc" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark text-white border-secondary shadow-lg rounded-4">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="confirmModalLabel">Confirm Import</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="confirmModalDesc">
        Are you sure you want to commit these changes to the database?
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" aria-label="Cancel">Cancel</button>
        <button id="modalConfirmBtn" type="button" class="btn btn-primary" aria-label="Confirm Import">‚úÖ Confirm Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="toast" class="toast align-items-center text-white bg-primary border-0 shadow rounded-3" role="alert" aria-live="assertive" aria-atomic="true" data-bs-delay="5000">
    <div class="d-flex">
      <div class="toast-body fw-semibold" id="toastBody">Processing...</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<!-- JS Logic -->
<script>
let lastFormData = null;

function showToast(message, type = 'primary') {
  const toastEl = document.getElementById('toast');
  const toastBody = document.getElementById('toastBody');
  toastEl.className = `toast align-items-center text-white bg-${type} border-0 shadow rounded-3`;
  toastBody.innerText = message;
  const toastInstance = bootstrap.Toast.getOrCreateInstance(toastEl, {
    animation: true,
    delay: 5000
  });
  toastInstance.show();
}

document.getElementById('uploadForm').addEventListener('submit', function (e) {
  e.preventDefault();
  const fileInput = document.getElementById('csv_file');
  const fileError = document.getElementById('fileError');
  const dryRun = document.getElementById('dry_run').checked;

  // Validate file type
  if (!fileInput.files[0]?.name.endsWith('.csv')) {
    fileInput.classList.add('is-invalid');
    fileError.textContent = 'Please upload a CSV file.';
    return;
  }
  fileInput.classList.remove('is-invalid');
  fileInput.classList.add('is-valid');

  const formData = new FormData();
  formData.append('csv_file', fileInput.files[0]);
  formData.append('dry_run', dryRun ? 'yes' : 'no');
  lastFormData = formData;
  submitFormData(formData, true);
});

document.getElementById('modalConfirmBtn').addEventListener('click', function () {
  if (!lastFormData) return;
  lastFormData.set('dry_run', 'no');
  submitFormData(lastFormData, false);
  const modal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
  modal.hide();
});

function submitFormData(formData, isDryRun) {
  const xhr = new XMLHttpRequest();
  const progressBar = document.getElementById('uploadProgress');
  const progressContainer = document.getElementById('progressContainer');
  const output = document.getElementById('output');

  output.innerHTML = '';
  progressContainer.classList.remove('d-none');
  progressBar.classList.add('progress-bar-animated');
  progressBar.style.width = '0%';
  progressBar.innerText = '0%';
  progressBar.setAttribute('aria-valuenow', '0');

  xhr.upload.addEventListener('progress', function (e) {
    if (e.lengthComputable) {
      const percent = Math.round((e.loaded / e.total) * 100);
      progressBar.style.width = percent + '%';
      progressBar.innerText = percent + '%';
      progressBar.setAttribute('aria-valuenow', percent);
    }
  });

  xhr.onreadystatechange = function () {
    if (xhr.readyState === 4) {
      progressBar.classList.remove('progress-bar-animated');
      const res = JSON.parse(xhr.responseText);
      if (xhr.status === 200 && res.success) {
        let html = `<div class="alert alert-success">${res.messages.join('<br>')}</div>`;
        html += `<div class="row text-center g-2 mb-3">
          <div class="col"><span class="badge text-bg-secondary">Processed: ${res.stats.processed}</span></div>
          <div class="col"><span class="badge text-bg-success">Added: ${res.stats.added}</span></div>
          <div class="col"><span class="badge text-bg-warning">Updated: ${res.stats.updated}</span></div>
          <div class="col"><span class="badge text-bg-danger">Deleted: ${res.stats.deleted}</span></div>
          <div class="col"><span class="badge text-bg-dark">Failed: ${res.stats.failed}</span></div>
        </div>`;
        if (res.preview_changes.length) {
          html += `<div class="accordion mb-3" id="previewAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePreview" aria-expanded="false" aria-controls="collapsePreview">üîç Preview Changes</button>
              </h2>
              <div id="collapsePreview" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <ul class="list-group">`;
          for (const change of res.preview_changes) {
            let icon = change.includes('Add') ? 'üü¢' : change.includes('Delete') ? 'üî¥' : 'üü°';
            html += `<li class="list-group-item">${icon} ${change}</li>`;
          }
          html += `</ul></div></div></div></div>`;
        }
        if (res.update_diffs.length) {
          html += `<div class="card mb-3"><div class="card-header">üìù Update Differences</div><div class="card-body">`;
          for (const upd of res.update_diffs) {
            html += `<h5>${upd.name} (MDOC: ${upd.mdoc})</h5><ul class="list-group mb-3">`;
            for (const field in upd.diffs) {
              const from = upd.diffs[field].from;
              const to = upd.diffs[field].to;
              html += `<li class="list-group-item"><strong>${field}</strong>: <s>${from}</s> ‚û°Ô∏è <strong>${to}</strong></li>`;
            }
            html += `</ul>`;
          }
          html += `</div></div>`;
        }
        if (isDryRun) {
          html += `<button id="confirmBtn" class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#confirmModal" aria-label="Confirm Changes">‚úÖ Confirm Changes</button>`;
        } else {
          showToast("‚úÖ Changes committed to the database.", 'success');
        }
        output.innerHTML = html;
      } else {
        output.innerHTML = `<div class="alert alert-danger">‚ùå ${res.message || 'Something went wrong.'}</div>`;
        showToast(res.message || 'Import failed.', 'danger');
      }
    }
  };
  xhr.open('POST', '/admin/residents/import/upload');
  xhr.send(formData);
}
</script>
{% endblock %}