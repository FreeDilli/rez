{% extends 'layout.html' %}

{% block title %}Scan Log{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Scan Log</h2>

  <!-- Filters -->
  <form id="filterForm" action="{{ url_for('scanlog.scanlog') }}" method="GET">
    <div class="row g-2 mb-3 align-items-end">
      <div class="col-md-3">
        <div class="form-group mb-3">
          <input type="text" id="searchInput" name="search" class="form-control" placeholder="Search by MDOC or Name..." value="{{ search }}" autocomplete="off">
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group mb-3">
          <select id="filterStatus" name="status" class="form-select">
            <option value="">All Statuses</option>
            {% for option in status_options %}
            <option value="{{ option }}" {% if option == status %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-md-3">
        <div class="form-group mb-3">
          <select id="filterLocation" name="location" class="form-select">
            <option value="">All Locations</option>
            {% for option in location_options %}
            <option value="{{ option }}" {% if option == location %}selected{% endif %}>{{ option }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="col-md-2">
        <div class="form-group mb-3">
          <button type="button" class="btn btn-secondary w-100" onclick="resetFilters()">Clear Filters</button>
        </div>
      </div>
    </div>
  </form>

  <!-- Table -->
  <div class="card p-3">
    <h5 class="card-title">Scan Log</h5>
    <div class="table-responsive">
      <table id="scansTable" class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>MDOC</th>
            <th>Name</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody>
          {% for scan in scans %}
          <tr>
            <td>{{ scan[0] }}</td>
            <td>{{ scan[1] or 'Unknown Resident' }}</td>
            <td>{{ scan[2] | dateformat }}</td>
            <td>{{ scan[2] | timeformat }}</td>
            <td>{{ scan[3] }}</td>
            <td>{{ scan[4] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- No results message -->
    <div id="noResults" class="text-center text-gray-500 mt-3" style="display: none;">
      No results found.
    </div>
    
    <!-- Pagination -->
    {% if total_pages > 1 %}
    <nav aria-label="Scan log pagination" class="mt-4">
      <ul class="pagination justify-content-center">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('scanlog.scanlog', page=1, search=search, status=status, location=location) }}" aria-label="First">
            <span aria-hidden="true">First</span>
          </a>
        </li>
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('scanlog.scanlog', page=page-1, search=search, status=status, location=location) }}" aria-label="Previous">
            <span aria-hidden="true">«</span>
          </a>
        </li>
        {% set start_page = [1, page-2]|max %}
        {% set end_page = [total_pages, page+2]|min %}
        {% for p in range(start_page, end_page + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
          <a class="page-link" href="{{ url_for('scanlog.scanlog', page=p, search=search, status=status, location=location) }}">{{ p }}</a>
        </li>
        {% endfor %}
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('scanlog.scanlog', page=page+1, search=search, status=status, location=location) }}" aria-label="Next">
            <span aria-hidden="true">»</span>
          </a>
        </li>
        <li class="page-item {% if page == total_pages %}disabled{% endif %}">
          <a class="page-link" href="{{ url_for('scanlog.scanlog', page=total_pages, search=search, status=status, location=location) }}" aria-label="Last">
            <span aria-hidden="true">Last</span>
          </a>
        </li>
      </ul>
    </nav>
    {% endif %}
    
    <div class="text-center text-muted mt-2">
      Showing {{ ((page-1)*per_page + 1) }} to {{ [page*per_page, total_records]|min }} of {{ total_records }} records
    </div>
  </div>
</div>

<script>
function submitFilters() {
  document.getElementById("filterForm").submit();
}

function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("filterStatus").value = "";
  document.getElementById("filterLocation").value = "";
  document.getElementById("filterForm").submit();
}

document.getElementById("searchInput").addEventListener("input", function() {
  clearTimeout(this.timeout);
  this.timeout = setTimeout(submitFilters, 500);
});

document.getElementById("filterStatus").addEventListener("change", submitFilters);
document.getElementById("filterLocation").addEventListener("change", submitFilters);
</script>
{% endblock %}