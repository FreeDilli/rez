{% extends 'layout.html' %}

{% block title %}Scan Log{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Scan Log</h2>

  <!-- Filters -->
  <div class="row g-2 mb-3 align-items-end">
    <div class="col-md-3">
      <div class="form-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search by MDOC or Name..." onkeyup="filterTable()" autocomplete="off">
      </div>
    </div>
    <div class="col-md-3">
      <div class="form-group mb-3">
        <select id="filterStatus" class="form-select" onchange="filterTable()">
          <option value="">All Statuses</option>
          {% for option in status_options %}
          <option value="{{ option }}">{{ option }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="col-md-3">
      <div class="form-group mb-3">
        <select id="filterLocation" class="form-select" onchange="filterTable()">
          <option value="">All Locations</option>
          {% for option in location_options %}
          <option value="{{ option }}">{{ option }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
    <div class="col-md-2">
      <div class="form-group mb-3">
        <button class="btn btn-secondary w-100" onclick="resetFilters()">Clear Filters</button>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card p-3">
    <h5 class="card-title">Scan Log</h5>
    <div class="table-responsive">
      <table id="scansTable" class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>MDOC</th>
            <th>Name</th>
            <th>Date</th>
            <th>Time</th>
            <th>Status</th>
            <th>Location</th>
          </tr>
        </thead>
        <tbody>
          {% for scan in scans %}
          <tr>
            <td>{{ scan[0] }}</td>
            <td>{{ scan[1] }}</td>
            <td>{{ scan[2] | dateformat }}</td>
            <td>{{ scan[2] | timeformat }}</td>
            <td>{{ scan[3] }}</td>
            <td>{{ scan[4] }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <!-- No results message -->
    <div id="noResults" class="text-center text-gray-500 mt-3" style="display: none;">
      No results found.
    </div>
  </div>
</div>

<script>
function filterTable() {
  const search = document.getElementById("searchInput").value.toLowerCase().trim();
  const status = document.getElementById("filterStatus").value.toLowerCase();
  const location = document.getElementById("filterLocation").value.toLowerCase();
  const rows = document.querySelectorAll("#scansTable tbody tr");
  const noResults = document.getElementById("noResults");
  let visibleRows = 0;

  rows.forEach(row => {
    const rowText = row.innerText.toLowerCase();
    const rowStatus = row.querySelector("td:nth-child(5)").innerText.toLowerCase();
    const rowLocation = row.querySelector("td:nth-child(6)").innerText.toLowerCase();
    const name = row.querySelector("td:nth-child(2)").innerText.toLowerCase();

    let matchSearch = rowText.includes(search);
    if (search && name) {
      const [lastName = "", firstName = ""] = name.split(",").map(part => part.trim());
      const fullName = `${firstName} ${lastName}`.trim();
      const reverseFullName = `${lastName} ${firstName}`.trim();
      matchSearch = (
        firstName.includes(search) ||
        lastName.includes(search) ||
        fullName.includes(search) ||
        reverseFullName.includes(search) ||
        rowText.includes(search)
      );
    }

    const matchStatus = status === "" || rowStatus === status;
    const matchLocation = location === "" || rowLocation === location;

    if (matchSearch && matchStatus && matchLocation) {
      row.style.display = "";
      visibleRows++;
    } else {
      row.style.display = "none";
    }
  });

  noResults.style.display = visibleRows === 0 ? "block" : "none";
}

function resetFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("filterStatus").value = "";
  document.getElementById("filterLocation").value = "";
  filterTable();
}
</script>
{% endblock %}