{% extends "layout.html" %}
{% block title %}Audit Log{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>üõ°Ô∏è Audit Log</h2>

    <form method="GET" class="row g-2 mb-4 align-items-end">
        <div class="col-md-3 col-sm-6">
            <label for="username_filter" class="form-label">Username</label>
            <input type="text" name="username" id="username_filter" class="form-control" placeholder="Filter by Username" value="{{ username_filter }}">
        </div>
        <div class="col-md-3 col-sm-6">
            <label for="action_filter" class="form-label">Action</label>
            <select name="action" id="action_filter" class="form-select">
                <option value="">All Actions</option>
                {% for action in actions %}
                    <option value="{{ action }}" {% if action == action_filter %}selected{% endif %}>{{ action }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2 col-sm-6">
            <label for="start_date" class="form-label">Start Date</label>
            <input type="date" name="start_date" id="start_date" class="form-control" value="{{ start_date }}">
        </div>
        <div class="col-md-2 col-sm-6">
            <label for="end_date" class="form-label">End Date</label>
            <input type="date" name="end_date" id="end_date" class="form-control" value="{{ end_date }}">
        </div>
        <div class="col-md-2 col-sm-12 d-flex gap-2">
            <button type="submit" class="btn btn-primary flex-fill">Apply</button>
            <a href="{{ url_for('audit_log.view_audit_log') }}" class="btn btn-secondary flex-fill">Clear</a>
        </div>
    </form>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="mb-0">Showing page {{ page }} of {{ total_pages }}</p>
        <a href="{{ url_for('audit_log.export_audit_log') }}" class="btn btn-success">üìÑ Export All</a>
    </div>

    {% if logs %}
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th>Timestamp</th>
                    <th>Username</th>
                    <th>Action</th>
                    <th>Target</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log[1] | datetimeformat }}</td>
                    <td>{{ log[2] }}</td>
                    <td>{{ log[3] }}</td>
                    <td>{{ log[4] }}</td>
                    <td>{{ log[5] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <nav aria-label="Audit Log Pagination" class="mt-4">
        <ul class="pagination justify-content-center">
            <!-- First Page -->
            {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('audit_log.view_audit_log', page=1, username=username_filter, action=action_filter, start_date=start_date, end_date=end_date) }}">First</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">First</span>
                </li>
            {% endif %}

            <!-- Previous Page -->
            {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('audit_log.view_audit_log', page=page-1, username=username_filter, action=action_filter, start_date=start_date, end_date=end_date) }}">Previous</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                </li>
            {% endif %}

            <!-- Page Numbers -->
            {% set range_size = 5 %}
            {% set half_range = range_size // 2 %}
            {% set start_page = [page - half_range, 1] | max %}
            {% set end_page = [start_page + range_size - 1, total_pages] | min %}
            {% if end_page - start_page < range_size - 1 %}
                {% set start_page = [end_page - range_size + 1, 1] | max %}
            {% endif %}
            {% for p in range(start_page, end_page + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('audit_log.view_audit_log', page=p, username=username_filter, action=action_filter, start_date=start_date, end_date=end_date) }}">{{ p }}</a>
                </li>
            {% endfor %}

            <!-- Next Page -->
            {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('audit_log.view_audit_log', page=page+1, username=username_filter, action=action_filter, start_date=start_date, end_date=end_date) }}">Next</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Next</span>
                </li>
            {% endif %}

            <!-- Last Page -->
            {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('audit_log.view_audit_log', page=total_pages, username=username_filter, action=action_filter, start_date=start_date, end_date=end_date) }}">Last</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <span class="page-link">Last</span>
                </li>
            {% endif %}
        </ul>
    </nav>

    {% else %}
    <div class="alert alert-info text-center mt-4">No audit logs found.</div>
    {% endif %}
</div>
{% endblock %}