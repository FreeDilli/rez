{% extends 'layout.html' %}
{% block title %}Match Preview - RezScan{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üß† Match Preview</h2>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="POST">
    <div class="mb-3">
      <label for="movement_text" class="form-label">Paste Movement Schedule</label>
      <textarea name="movement_text" id="movement_text" rows="10" class="form-control">{{ raw_text }}</textarea>
    </div>
    <button type="submit" class="btn btn-primary"><i class="bi bi-search"></i> Parse & Preview</button>
  </form>

  {% if summary %}
  <div class="mt-4 alert alert-dark border">
    <strong>Summary:</strong>
    ‚úÖ Matched: <span class="badge bg-success">{{ summary.matched }}</span>,
    ‚ùì Unmatched: <span class="badge bg-danger">{{ summary.unmatched }}</span>,
    ‚ö†Ô∏è Conflicted: <span class="badge bg-warning text-dark">{{ summary.conflicted }}</span>,
    üîç Fuzzy Suggestions: <span class="badge bg-info text-dark">{{ summary.fuzzy }}</span>
  </div>

  {% if summary.unmatched > 0 or summary.conflicted > 0 or summary.fuzzy > 0 %}
  <div class="mt-3 text-end">
    <a href="{{ url_for('schedule_review.review_matches') }}" class="btn btn-warning">
      <i class="bi bi-clipboard-check"></i> Review Unmatched
    </a>
  </div>
  {% endif %}
  {% endif %}

  {% for block in blocks %}
    <div class="card mt-4">
      <div class="card-header">
        <strong>{{ block.start }}</strong> ‚Äî <em>{{ block.title }}</em>
      </div>
      <div class="card-body">
        {% if block.matched %}
          <p><strong>‚úÖ Matched:</strong></p>
          <ul>
            {% for m in block.matched %}
              <li>{{ m.name }} ({{ m.mdoc }}) - {{ m.housing_unit }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if block.unmatched %}
          <p><strong>‚ùì Unmatched:</strong></p>
          <ul>
            {% for u in block.unmatched %}
              <li>{{ u }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if block.conflicts %}
          <p><strong>‚ö†Ô∏è Conflicted:</strong></p>
          <ul>
            {% for c in block.conflicts %}
              <li>{{ c }}</li>
            {% endfor %}
          </ul>
        {% endif %}
        {% if block.fuzzy %}
          <p><strong>üîç Fuzzy Suggestions:</strong></p>
          <ul>
            {% for f in block.fuzzy %}
              <li><em>{{ f.original }}</em> ‚Üí <strong>{{ f.name }}</strong> ({{ f.mdoc }})</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}
