{% extends 'layout.html' %}
{% block title %}Schedule Match Review{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4"><i class="bi bi-pencil-square me-2"></i>Schedule Match Review</h2>

  <!-- Auto-Approve Toggle -->
  <form method="post" action="{{ url_for('schedule_review.toggle_auto_approve') }}" class="mb-3">
    <input type="hidden" name="enable" value="{{ '0' if session.get('auto_approve_enabled', True) else '1' }}">
    <button type="submit" class="btn btn-outline-primary">
      Auto-Approve High Confidence Matches:
      <strong>{{ 'On' if session.get('auto_approve_enabled', True) else 'Off' }}</strong>
    </button>
  </form>

  {% if matches %}
    <table class="table table-dark table-bordered align-middle">
      <thead>
        <tr>
          <th>ID</th>
          <th>Block Info</th>
          <th>Source</th>
          <th>Suggested Match</th>
          <th>Type</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for match in matches %}
        <tr>
          <td>{{ match.id }}</td>
          <td>
            <strong>{{ match.block_title }}</strong><br>
            <small>{{ match.block_time }}</small>
          </td>
          <td>{{ match.source_line }}</td>
          <td>
            <strong>{{ match.suggested_name or '—' }}</strong><br>
            {% if match.candidates %}
              <small class="text-muted">Found {{ match.candidates | length }} candidate(s):</small>
              <ul class="small mb-1">
                {% for r in match.candidates %}
                  <li>{{ r.name }} — {{ r.mdoc }} ({{ r.housing_unit or 'n/a' }})</li>
                {% endfor %}
              </ul>
            {% endif %}
          </td>
          <td>
            <span class="badge bg-info text-dark">{{ match.match_type|capitalize }}</span>
          </td>
          <td>
            <span class="badge bg-secondary">{{ match.status|capitalize }}</span>
          </td>
          <td>
            {% if match.can_auto_approve %}
              <form method="post" action="{{ url_for('schedule_review.approve_match_by_id', match_id=match.id) }}">
                <button class="btn btn-success btn-sm" type="submit">✅ Auto Approve</button>
              </form>
            {% elif match.db_check and match.candidates %}
              <form method="post" action="{{ url_for('schedule_review.approve_manual') }}">
                <input type="hidden" name="match_id" value="{{ match.id }}">
                <div class="input-group input-group-sm mb-1">
                  <select name="selected_mdoc" class="form-select">
                    {% for r in match.candidates %}
                    <option value="{{ r.mdoc }}">{{ r.name }} ({{ r.mdoc }})</option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-success" type="submit">Approve</button>
                </div>
              </form>
            {% endif %}

            {% if match.status == 'pending' %}
              <form action="{{ url_for('schedule_review.review_manual', match_id=match.id) }}" method="get" class="mb-1">
                <button class="btn btn-outline-warning btn-sm" type="submit">
                  <i class="bi bi-wrench"></i> Manual
                </button>
              </form>
            {% endif %}

            <form method="post" action="{{ url_for('schedule_review.delete_match', match_id=match.id) }}">
              <button class="btn btn-outline-danger btn-sm" type="submit">Reject</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <div class="alert alert-info">No pending matches to review.</div>
  {% endif %}
</div>
{% endblock %}
