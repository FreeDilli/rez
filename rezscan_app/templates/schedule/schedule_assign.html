{% extends 'layout.html' %}
{% block title %}Assign Residents - {{ group_name }}{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Assign Residents to <span class="text-primary">{{ group_name }}</span></h2>

  <form method="post" action="">
    <div class="card card-body shadow-sm mb-4">
      <input type="text" id="searchBox" class="form-control mb-3" placeholder="Search residents...">

      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th>
                <input type="checkbox" id="selectAll">
                <label for="selectAll" class="ms-2">Select All (<span id="selectedCount">0</span>)</label>
              </th>
              <th>MDOC</th>
              <th>Name</th>
              <th>Unit</th>
              <th>Housing</th>
              <th>Level</th>
            </tr>
          </thead>
          <tbody>
            {% for r in residents %}
            <tr>
              <td>
                <input type="checkbox" name="assign[]" value="{{ r[2] }}" {% if r[2] in assigned %}checked{% endif %}>
              </td>
              <td>{{ r[2] }}</td>
              <td>{{ r[1] }}</td>
              <td>{{ r[3] }}</td>
              <td>{{ r[4] }}</td>
              <td>{{ r[5] }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="mt-3 d-flex justify-content-between">
      <a href="{{ url_for('schedules.manage_schedules') }}" class="btn btn-outline-secondary">Cancel</a>
      <button type="submit" class="btn btn-primary">ðŸ’¾ Save Assignments</button>
    </div>
  </form>
</div>

<script>
  const searchBox = document.getElementById("searchBox");
  const selectAllCheckbox = document.getElementById("selectAll");
  const checkboxes = document.querySelectorAll('input[name="assign[]"]');
  const selectedCountDisplay = document.getElementById("selectedCount");

  function updateSelectedCount() {
    const count = Array.from(checkboxes).filter(cb => cb.checked).length;
    selectedCountDisplay.textContent = count;
  }

  checkboxes.forEach(cb => {
    cb.addEventListener("change", updateSelectedCount);
  });

  selectAllCheckbox.addEventListener("change", function () {
    checkboxes.forEach(cb => {
      if (cb.closest('tr').style.display !== "none") {
        cb.checked = this.checked;
      }
    });
    updateSelectedCount();
  });

  searchBox.addEventListener("keyup", function () {
    const filter = this.value.toLowerCase();
    document.querySelectorAll("table tbody tr").forEach(row => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(filter) ? "" : "none";
    });
    updateSelectedCount();
  });

  // Initial count on load
  updateSelectedCount();
</script>
{% endblock %}

