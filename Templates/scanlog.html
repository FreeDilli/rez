{% extends 'layout.html' %}

{% block title %}Scan Log{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h2 class="text-2xl font-bold mb-6 text-gray-800">Scan Log</h2>
    <div class="mb-4">
        <a href="{{ url_for('export_scanlog') }}" class="btn btn-success">Export Scan Log</a>
        <form action="" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete the scan log?');">
            <button type="submit" class="btn btn-danger">Delete Scan Log</button>
        </form>
    </div>
    <!-- Filters -->
    <div class="row g-2 mb-3 align-items-end">
        <div class="col-md-3">
            <input type="text" id="searchInput" class="form-control" placeholder="Search by MDOC or Name..." onkeyup="filterTable()" autocomplete="off">
        </div>
        <div class="col-md-3">
            <select id="filterStatus" class="form-select" onchange="filterTable()">
                <option value="">All Statuses</option>
                {% for option in status_options %}
                <option value="{{ option }}">{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <select id="filterLocation" class="form-select" onchange="filterTable()">
                <option value="">All Locations</option>
                {% for option in location_options %}
                <option value="{{ option }}">{{ option }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary w-100" onclick="resetFilters()">Clear Filters</button>
        </div>
    </div>

    <!-- Table -->
    <div class="card p-3">
        <h5 class="card-title">Scan Log</h5>
        <div class="table-responsive">
            <table id="scansTable" class="table table-striped mt-3 align-middle">
                <thead class="table-light">
                    <tr>
                        <th>MDOC</th>
                        <th>Name</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Status</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody>
                    {% for scan in scans %}
                    <tr>
                        <td>{{ scan[0] }}</td>
                        <td>{{ scan[1] }}</td>
                        <td>{{ scan[2] }}</td>
                        <td>{{ scan[3] }}</td>
                        <td>{{ scan[4] }}</td>
                        <td>{{ scan[5] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- No results message -->
        <div id="noResults" class="text-center text-gray-500 mt-3" style="display: none;">
            No results found.
        </div>
    </div>
</div>

<!-- Include Tailwind CSS via CDN -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<!-- Include Bootstrap CSS for form-control and table styles -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<script>
    function filterTable() {
        const search = document.getElementById("searchInput").value.toLowerCase().trim();
        const status = document.getElementById("filterStatus").value.toLowerCase();
        const location = document.getElementById("filterLocation").value.toLowerCase();
        const rows = document.querySelectorAll("#scansTable tbody tr");
        const noResults = document.getElementById("noResults");
        let visibleRows = 0;

        rows.forEach(row => {
            const rowText = row.innerText.toLowerCase();
            const rowStatus = row.querySelector("td:nth-child(5)").innerText.toLowerCase();
            const rowLocation = row.querySelector("td:nth-child(6)").innerText.toLowerCase();
            const name = row.querySelector("td:nth-child(2)").innerText.toLowerCase(); // Name field (e.g., "cardilli, mark")

            // Process the name field
            let matchSearch = rowText.includes(search); // Default check for MDOC or partial matches
            if (search && name) {
                // Split name into last and first (assuming format "LAST, FIRST")
                const [lastName = "", firstName = ""] = name.split(",").map(part => part.trim());
                const fullName = `${firstName} ${lastName}`.trim(); // e.g., "mark cardilli"
                const reverseFullName = `${lastName} ${firstName}`.trim(); // e.g., "cardilli mark"

                // Check if search matches first name, last name, full name, reverse full name, or original row text
                matchSearch = (
                    firstName.includes(search) ||
                    lastName.includes(search) ||
                    fullName.includes(search) ||
                    reverseFullName.includes(search) ||
                    rowText.includes(search)
                );
            }

            const matchStatus = status === "" || rowStatus === status;
            const matchLocation = location === "" || rowLocation === location;

            if (matchSearch && matchStatus && matchLocation) {
                row.style.display = "";
                visibleRows++;
            } else {
                row.style.display = "none";
            }
        });

        // Show or hide "No results" message
        noResults.style.display = visibleRows === 0 ? "block" : "none";
    }

    function resetFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("filterStatus").value = "";
        document.getElementById("filterLocation").value = "";
        filterTable();
    }
</script>
{% endblock %}