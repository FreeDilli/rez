{% extends "layout.html" %}
{% block title %}Change Password - RezScan{% endblock %}

{% block content %}
<h2 class="mb-4">Change Password</h2>

<!-- Toast Container (for top-right floating messages) -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
  <div id="toast-container"></div>
</div>

<div class="card p-4">
  <h5 class="card-title mb-3">Update Your Password</h5>
  
  <div id="clientError" class="alert alert-danger d-none" role="alert"></div>

  <form method="POST" id="changePasswordForm">
    <div class="mb-3">
      <label class="form-label">Current Password</label>
      <input type="password" name="current_password" id="current_password" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">New Password</label>
      <input type="password" name="new_password" id="new_password" class="form-control" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Confirm New Password</label>
      <input type="password" name="confirm_password" id="confirm_password" class="form-control" required>
    </div>
    <div class="text-end">
      <button type="submit" class="btn btn-success">Save New Password</button>
      <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary">Cancel</a>
    </div>
  </form>
</div>

<script>
// Password validation
const newPasswordInput = document.getElementById('new_password');
const confirmPasswordInput = document.getElementById('confirm_password');
const form = document.getElementById('changePasswordForm');
const errorDiv = document.getElementById('clientError');

function validatePasswords() {
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    errorDiv.classList.add('d-none');
    errorDiv.textContent = '';
    newPasswordInput.classList.remove('is-invalid', 'is-valid');
    confirmPasswordInput.classList.remove('is-invalid', 'is-valid');

    if (newPassword && newPassword.length < 8) {
        errorDiv.textContent = 'New password must be at least 8 characters.';
        errorDiv.classList.remove('d-none');
        newPasswordInput.classList.add('is-invalid');
        return false;
    }

    if (newPassword && confirmPassword && newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match.';
        errorDiv.classList.remove('d-none');
        newPasswordInput.classList.add('is-invalid');
        confirmPasswordInput.classList.add('is-invalid');
        return false;
    }

    if (newPassword.length >= 8 && newPassword === confirmPassword) {
        newPasswordInput.classList.add('is-valid');
        confirmPasswordInput.classList.add('is-valid');
    }

    return true;
}

newPasswordInput.addEventListener('input', validatePasswords);
confirmPasswordInput.addEventListener('input', validatePasswords);

form.addEventListener('submit', function(event) {
    if (!validatePasswords()) {
        event.preventDefault();
    }
});

// Toasts for flash messages
document.addEventListener('DOMContentLoaded', function () {
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-bg-{{ 'success' if category == 'success' else 'danger' if category == 'danger' else 'warning' }} border-0';
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              {{ message }}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        document.getElementById('toast-container').appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 4000 });
        toast.show();
      {% endfor %}
    {% endif %}
    {% endwith %}
});
</script>

{% endblock %}

