{% extends "layout.html" %}
{% block title %}Change Password - RezScan{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Change Password</h2>

  <div class="card p-4">
    <h5 class="card-title mb-3">Update Your Password</h5>
    
    <div id="clientError" class="alert alert-danger d-none" role="alert" aria-live="assertive"></div>

    <form method="POST" id="changePasswordForm">
      <div class="mb-3">
        <label class="form-label" for="current_password">Current Password</label>
        <input type="password" name="current_password" id="current_password" class="form-control" required aria-label="Current Password">
      </div>
      <div class="mb-3">
        <label class="form-label" for="new_password">New Password</label>
        <input type="password" name="new_password" id="new_password" class="form-control" required aria-label="New Password" aria-describedby="clientError">
      </div>
      <div class="mb-3">
        <label class="form-label" for="confirm_password">Confirm New Password</label>
        <input type="password" name="confirm_password" id="confirm_password" class="form-control" required aria-label="Confirm New Password" aria-describedby="clientError">
      </div>
      <div class="text-end">
        <button type="submit" class="btn btn-success" aria-label="Save New Password">Save New Password</button>
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-outline-secondary" aria-label="Cancel">Cancel</a>
      </div>
    </form>
  </div>
</div>

<script>
// Password validation (only checks if passwords match)
const newPasswordInput = document.getElementById('new_password');
const confirmPasswordInput = document.getElementById('confirm_password');
const form = document.getElementById('changePasswordForm');
const errorDiv = document.getElementById('clientError');

function validatePasswords() {
    const newPassword = newPasswordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    
    errorDiv.classList.add('d-none');
    errorDiv.textContent = '';
    newPasswordInput.classList.remove('is-invalid', 'is-valid');
    confirmPasswordInput.classList.remove('is-invalid', 'is-valid');

    if (newPassword && confirmPassword && newPassword !== confirmPassword) {
        errorDiv.textContent = 'Passwords do not match.';
        errorDiv.classList.remove('d-none');
        newPasswordInput.classList.add('is-invalid');
        confirmPasswordInput.classList.add('is-invalid');
        return false;
    }

    if (newPassword && confirmPassword && newPassword === confirmPassword) {
        newPasswordInput.classList.add('is-valid');
        confirmPasswordInput.classList.add('is-valid');
    }

    return true;
}

newPasswordInput.addEventListener('input', validatePasswords);
confirmPasswordInput.addEventListener('input', validatePasswords);

form.addEventListener('submit', function(event) {
    if (!validatePasswords()) {
        event.preventDefault();
    } else {
        // Show success toast (client-side, assumes success)
        const toastEl = document.createElement('div');
        toastEl.className = 'toast align-items-center text-bg-success border-0';
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        toastEl.setAttribute('data-bs-delay', '5000');
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              âœ… Password changed successfully.
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        document.getElementById('toast-container').appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }
});
</script>

{% endblock %}