{% extends "layout.html" %}

{% macro sort_link(column_name, label) %}
  {% set current_sort = request.args.get('sort', '') %}
  {% set current_dir = request.args.get('direction', 'asc') %}
  {% set next_dir = 'desc' if current_sort == column_name and current_dir == 'asc' else 'asc' %}

  <a href="{{ url_for('residents.residents') }}?{{ request.query_string|safe }}&sort={{ column_name }}&direction={{ next_dir }}" class="text-decoration-none">
    {{ label }}
    {% if current_sort == column_name %}
      {% if current_dir == 'asc' %}
        &#9650;
      {% else %}
        &#9660;
      {% endif %}
    {% endif %}
  </a>
{% endmacro %}

{% block title %}Residents - RezScan{% endblock %}

{% block content %}
<h2 class="mb-4">Residents</h2>

<!-- 🔍 Search Bar -->
<form method="GET" class="row g-3 mb-4">
  <div class="col-md-4">
    <input type="text" name="search" class="form-control" placeholder="Search by Name or MDOC" value="{{ request.args.get('search', '') }}">
  </div>
  <div class="col-md-auto">
    <button type="submit" class="btn btn-primary">Search</button>
    <a href="{{ url_for('residents.residents') }}" class="btn btn-secondary">Clear</a>
  </div>
  {% if current_user.role in ['admin', 'officer'] %}
  <div class="col-md-auto ms-auto">
    <a href="{{ url_for('residents.add_resident') }}" class="btn btn-success">+ Add Resident</a>
  </div>
  {% endif %}
</form>

<!-- 🧍 Residents Table -->
<div class="table-responsive">
  <table class="table table-bordered table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th>{{ sort_link('name', 'Name') }}</th>
        <th>{{ sort_link('mdoc', 'MDOC') }}</th>
        <th>Area</th>
        <th>Housing</th>
        <th>{{ sort_link('level', 'Level') }}</th>
        {% if current_user.role in ['admin', 'officer'] %}
        <th class="text-center">Actions</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for resident in residents %}
      <tr>
        <td>{{ resident.name }}</td>
        <td>{{ resident.mdoc }}</td>
        <td>{{ resident.area }}</td>
        <td>{{ resident.housing_unit }}</td>
        <td>{{ resident.level }}</td>
        {% if current_user.role in ['admin', 'officer'] %}
        <td class="text-center">
          <a href="{{ url_for('residents_edit.edit_resident', mdoc=resident.mdoc) }}" class="btn btn-sm btn-outline-primary">Edit</a>
          <a href="{{ url_for('residents_delete.delete_resident', mdoc=resident.mdoc) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Are you sure you want to delete this resident?');">Delete</a>
        </td>
        {% endif %}
      </tr>
      {% else %}
      <tr>
        <td colspan="6" class="text-center text-muted">No residents found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-center mt-4">
  <nav>
    <ul class="pagination">
      {% if prev_page %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('residents.residents') }}?{{ request.query_string|safe }}&page={{ prev_page }}">Previous</a>
        </li>
      {% endif %}
      {% if next_page %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('residents.residents') }}?{{ request.query_string|safe }}&page={{ next_page }}">Next</a>
        </li>
      {% endif %}
    </ul>
  </nav>
</div>

{% endblock %}
